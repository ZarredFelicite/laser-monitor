# Laser Monitor Web Dashboard

Flask-based web dashboard for monitoring laser cutter activity and managing detection boxes.

## Features

### Machine Monitoring
- Real-time machine status (active/inactive)
- Latest detection image with auto-refresh
- Machine statistics (total, active, inactive machines)
- True uptime percentage (last hour)
- Per-machine uptime breakdown
- 24-hour activity charts by machine

### Detection Box Controls
- **Live visual overlay** - Boxes drawn on latest detection image in real-time
  - Green borders with semi-transparent fill
  - Box labels with dimensions (e.g., "Box 1: 128Ã—96px")
  - Corner handles and center crosshair for reference
  - Instant visual feedback when adjusting
- **Add new detection boxes** - Creates default 100x100px boxes in center
- **Position controls** - Move boxes with X+/X-/Y+/Y- buttons (10px steps)
- **Size controls** - Resize boxes with W+/W-/H+/H- buttons (10px steps)
- **Delete boxes** - Remove with confirmation dialog
- **Real-time save** - Changes persist immediately and overlay updates instantly

## Configuration System

### How Settings Are Saved

Detection boxes configured via the web UI are saved to:
```
/home/zarred/dev/laser-monitor/web_ui.config.py
```

This file is a **Python config file** in the same format as those generated by `visual_prompt_selector.py`:

```python
#!/usr/bin/env python3
# Reference image path
refer_image = r"/path/to/output/screenshots/detection_YYYYMMDD_HHMMSS.jpg"

# Visual prompt bounding boxes (normalized coordinates: x1, y1, x2, y2)
visual_prompts = [[x1, y1, x2, y2], [x1, y1, x2, y2]]

# Image dimensions
image_dimensions = {"width": 1920, "height": 1080}

# Metadata
metadata = {
    "created_with": "web_ui_dashboard",
    "num_prompts": 2,
    "last_modified": "2025-11-12T..."
}
```

### How ConfigManager Loads It

When `laser_monitor` starts:

1. **Auto-detection**: `ConfigManager._find_visual_prompt_config()` scans for `*.config.py` files
2. **Pattern match**: Finds `web_ui.config.py` (matches `*.config.py` pattern)
3. **Validation**: Checks file contains both `visual_prompts` and `refer_image`
4. **Loading**: Calls `create_config_with_visual_prompts(default_config, "web_ui.config.py")`
5. **Merging**: Sets `detection.mode = "visual"` and populates `detection.visual_prompts`

### Config Priority

If multiple config files exist, ConfigManager uses the first match found:
- Explicitly specified config (`--config path/to/config.py`)
- Auto-detected configs in order: `*.config.py`, `*_visual_prompt.py`, `test*.config.py`

### Applying Changes

**Hot-Reload (Automatic)**: Changes take effect on the **next detection cycle** - no restart required!

When the laser monitor is running in continuous mode:
1. Make changes in the web UI
2. Web UI saves to `web_ui.config.py`
3. Monitor automatically detects file modification before next cycle
4. Visual prompts reload instantly
5. Next image uses updated detection boxes

**Technical Details**:
- `LaserMonitor.reload_visual_prompts()` runs before each detection cycle
- Checks `web_ui.config.py` modification time (`st_mtime`)
- Only reloads if file has been modified since last check
- Works in both continuous monitoring and single-shot modes
- Logging message: "Detection boxes updated from web UI"

**Manual Restart (Alternative)**:
```bash
# If monitor is not running, start it:
python cli.py monitor

# Or specify config explicitly:
python cli.py monitor --config web_ui.config.py
```

## API Endpoints

### GET `/api/detection-boxes`
Returns current detection boxes and image dimensions.

**Response:**
```json
{
  "boxes": [[x1, y1, x2, y2], ...],
  "image_dimensions": [1920, 1080]
}
```

### POST `/api/detection-boxes`
Updates all detection boxes.

**Request:**
```json
{
  "boxes": [[x1, y1, x2, y2], ...]
}
```

**Response:**
```json
{
  "success": true,
  "boxes": [[x1, y1, x2, y2], ...]
}
```

### DELETE `/api/detection-boxes/<index>`
Deletes a specific detection box by index.

**Response:**
```json
{
  "success": true,
  "deleted": [x1, y1, x2, y2],
  "boxes": [...]
}
```

### GET `/api/stats`
Returns machine statistics and activity data.

### GET `/api/latest-image`
Serves the latest detection screenshot.

## Running the Server

```bash
cd server
python app.py
```

Server runs on `http://localhost:5000`

## Development

- **Backend**: Flask (Python) in `app.py`
- **Frontend**: Vanilla JavaScript with Chart.js
- **Responsive**: Mobile-friendly with CSS media queries
- **No build step**: Direct HTML/CSS/JS serving

## Notes

- Detection boxes use normalized coordinates (0-1 range)
- Coordinates are relative to image dimensions stored in config
- Web UI automatically converts between pixel and normalized coords
- **Changes take effect on the next image** - hot-reload enabled!
